import { useEffect, useState, useMemo } from "react";
import { Link, useSearchParams } from "react-router-dom";
import Header from "../../header";
import Footer from "../../home/home-1/footer";
import ImageWithBasePath from "../../../../components/imageWithBasePath";
import { DatePicker, Slider } from "antd";
import doctorsDataEn from "./doctors.en.json";
import doctorsDataAr from "./doctors.ar.json";
import { all_routes as route } from "../../../../routes/all_routes";
import { useTranslation } from 'react-i18next';

// Helper function to convert Arabic numerals to regular digits
const convertArabicNumerals = (str: string): string => {
  const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
  let result = str;
  arabicNumerals.forEach((arabic, index) => {
    result = result.replace(new RegExp(arabic, 'g'), index.toString());
  });
  return result;
};

const DoctorGrid = (props: any) => {
  const { t, i18n, ready } = useTranslation('doctors');
  const isRTL = i18n.language === 'ar';
  const [sliderKey, setSliderKey] = useState(0);
  const [searchParams] = useSearchParams();
  
  // Select the correct doctors data based on current language
  const doctorsData = useMemo(() => {
    return i18n.language === 'ar' ? doctorsDataAr : doctorsDataEn;
  }, [i18n.language]);

  // If translations are not ready, show loading or return null
  if (!ready) return <div>Loading...</div>;

  useEffect(() => {
    // Force re-render when language changes
    setSliderKey(prev => prev + 1);
  }, [i18n.language]);

  const formatter = (value: any) => `${value} EGP`;

  const [showMenu, setShowMenu] = useState(false);
  const [showMenu2, setShowMenu2] = useState(false);
  const [showMenu3, setShowMenu3] = useState(false);
  const [showMenu4, setShowMenu4] = useState(false);
  const [sortOrder, setSortOrder] = useState("none");

  // ------ PAGINATION LOGIC ------
  const [currentPage, setCurrentPage] = useState(1);
  const doctorsPerPage = 12;

  // derive some lists and numeric ranges from the data - recalculate when data changes
  const parsedPrices = useMemo(() => 
    doctorsData.map((d) => {
      const converted = convertArabicNumerals(d.consultationFee);
      return parseInt(converted.replace(/[^0-9]/g, "")) || 0;
    }),
    [doctorsData]
  );
  const minPriceVal = useMemo(() => 
    parsedPrices.length ? Math.min(...parsedPrices) : 0,
    [parsedPrices]
  );
  const maxPriceVal = useMemo(() => 
    parsedPrices.length ? Math.max(...parsedPrices) : 0,
    [parsedPrices]
  );

  const specialities = useMemo(() => 
    Array.from(new Set(doctorsData.map((d) => d.speciality))).sort(),
    [doctorsData]
  );

  // availabilities derived from data are available if needed later

  const ratingOptions = [5, 4, 3, 2, 1];

  // Centralized simple filter state (local to this page)
  const [filters, setFilters] = useState({
    selectedSpecialities: [] as string[],
    selectedChannels: [] as string[],
    selectedGenders: [] as string[],
    selectedLanguages: [] as string[],
    selectedExperience: [] as number[],
    priceRange: [minPriceVal, maxPriceVal] as [number, number],
    selectedRatings: [] as number[],
    searchText: "",
    selectedDate: "",
    locationText: "",
  });
  
  // Reset price range when data changes
  useEffect(() => {
    setFilters(prev => ({
      ...prev,
      priceRange: [minPriceVal, maxPriceVal]
    }));
  }, [minPriceVal, maxPriceVal]);

  // Apply query parameters from URL (search, location)
  useEffect(() => {
    const searchQuery = searchParams.get('search');
    const locationQuery = searchParams.get('location');
    
    if (searchQuery || locationQuery) {
      setFilters(prev => ({
        ...prev,
        searchText: searchQuery || '',
        locationText: locationQuery || ''
      }));
    }
  }, [searchParams]);

  const toggleFilter = (key: keyof typeof filters, value: any) => {
    setFilters((prev) => {
      const list = prev[key] as any[];
      const exists = list.includes(value);
      const next = exists ? list.filter((v) => v !== value) : [...list, value];
      return { ...prev, [key]: next } as typeof prev;
    });
    setCurrentPage(1);
  };

  const setPriceRange = (range: [number, number]) => {
    setFilters((prev) => ({ ...prev, priceRange: range }));
    setCurrentPage(1);
  };

  const setSearchText = (text: string) => {
    setFilters((prev) => ({ ...prev, searchText: text }));
    setCurrentPage(1);
  };

  const setLocationText = (text: string) => {
    setFilters((prev) => ({ ...prev, locationText: text }));
    setCurrentPage(1);
  };

  // Compute filtered and sorted list using useMemo
  const filteredAndSorted = useMemo(() => {
    let list = [...doctorsData];

    // search text - supports both Arabic and English
    if (filters.searchText && filters.searchText.trim() !== "") {
      const searchLower = filters.searchText.trim().toLowerCase();
      list = list.filter(
        (d) =>
          d.doctorName.toLowerCase().includes(searchLower) ||
          d.doctorName.includes(filters.searchText) || // Direct match for Arabic
          d.speciality.toLowerCase().includes(searchLower) ||
          d.speciality.includes(filters.searchText) // Direct match for Arabic
      );
    }

    // speciality
    if (filters.selectedSpecialities.length > 0) {
      list = list.filter((d) =>
        filters.selectedSpecialities.includes(d.speciality)
      );
    }

    // availability filter removed (UI no longer exposes availability)

    // consultation channels (audio/video/instant/chat) - best-effort match against the `duration` or other fields
    if (filters.selectedChannels.length > 0) {
      list = list.filter((d) =>
        filters.selectedChannels.some((ch) => {
          // prefer explicit channels array on doctor, fall back to duration text
          if (
            Array.isArray((d as any).channels) &&
            (d as any).channels.length
          ) {
            return (d as any).channels.includes(ch);
          }
          return (d.duration || "").toLowerCase().includes(ch.toLowerCase());
        })
      );
    }

    // gender
    if (filters.selectedGenders.length > 0) {
      list = list.filter((d) =>
        filters.selectedGenders.includes((d as any).gender)
      );
    }

    // languages
    if (filters.selectedLanguages.length > 0) {
      list = list.filter((d) => {
        if (
          Array.isArray((d as any).languages) &&
          (d as any).languages.length
        ) {
          return filters.selectedLanguages.some((lang) =>
            (d as any).languages.includes(lang)
          );
        }
        return false;
      });
    }

    // clinics filter removed (UI no longer exposes clinics)

    // experience - selectedExperience contains numeric thresholds (e.g., 2,5,7,10)
    if (filters.selectedExperience.length > 0) {
      list = list.filter((d) => {
        const exp = Number((d as any).experienceYears || 0);
        return filters.selectedExperience.some((th) => exp >= Number(th));
      });
    }

    // location text
    if (filters.locationText && filters.locationText.trim() !== "") {
      const l = filters.locationText.toLowerCase();
      list = list.filter((d) => (d.location || "").toLowerCase().includes(l));
    }

    // price range
    list = list.filter((d) => {
      const converted = convertArabicNumerals(d.consultationFee);
      const price = parseInt(converted.replace(/[^0-9]/g, "").trim());
      return price >= filters.priceRange[0] && price <= filters.priceRange[1];
    });

    // rating
    if (filters.selectedRatings.length > 0) {
      list = list.filter((d) =>
        filters.selectedRatings.some((r) => d.rating >= r)
      );
    }

    // sort
    if (sortOrder === "low") {
      list.sort(
        (a, b) =>
          parseInt(convertArabicNumerals(a.consultationFee).replace(/[^0-9]/g, "")) -
          parseInt(convertArabicNumerals(b.consultationFee).replace(/[^0-9]/g, ""))
      );
    } else if (sortOrder === "high") {
      list.sort(
        (a, b) =>
          parseInt(convertArabicNumerals(b.consultationFee).replace(/[^0-9]/g, "")) -
          parseInt(convertArabicNumerals(a.consultationFee).replace(/[^0-9]/g, ""))
      );
    }

    return list;
  }, [doctorsData, filters, sortOrder]);

  const totalPages = Math.ceil(filteredAndSorted.length / doctorsPerPage);
  const startIndex = (currentPage - 1) * doctorsPerPage;
  const currentDoctors = filteredAndSorted.slice(
    startIndex,
    startIndex + doctorsPerPage
  );

  return (
    <>
      <Header {...props} />
      {/* Breadcrumb */}
      <div className="breadcrumb-bar overflow-visible">
        <div className="container">
          <div className="row align-items-center inner-banner">
            <div className="col-md-12 col-12 text-center">
              <nav aria-label="breadcrumb" className="page-breadcrumb">
                <ol className="breadcrumb">
                  <li className="breadcrumb-item">
                    <Link to="/index">
                      <i className="isax isax-home-15" />
                    </Link>
                  </li>
                  <li className="breadcrumb-item">{t('grid.breadcrumb.doctor')}</li>
                  <li className="breadcrumb-item active">{t('grid.breadcrumb.our_doctors')}</li>
                </ol>
                <h2 className="breadcrumb-title">{t('grid.breadcrumb.our_doctors')}</h2>
              </nav>
            </div>
          </div>

          <div className="bg-primary-gradient rounded-pill doctors-search-box">
            <div className="search-box-one rounded-pill">
              <form onSubmit={(e) => e.preventDefault()}>
                <div className="search-input search-line">
                  <i className="isax isax-hospital5 bficon" />
                  <div className=" mb-0">
                    <input
                      type="text"
                      className="form-control doctor-search-input"
                      placeholder={t('grid.search.placeholder')}
                      value={filters.searchText}
                      onChange={(e) => setSearchText(e.target.value)}
                    />
                  </div>
                </div>

                <div className="search-input search-map-line">
                  <i className="isax isax-location5" />
                  <div className=" mb-0">
                    <input
                      type="text"
                      className="form-control doctor-search-input"
                      placeholder={t('grid.search.location_placeholder')}
                      value={filters.locationText}
                      onChange={(e) => setLocationText(e.target.value)}
                    />
                  </div>
                </div>

                <div className="search-input search-calendar-line">
                  <i className="isax isax-calendar-tick5" />
                  <div className=" mb-0">
                    <DatePicker
                      className="form-control datetimepicker doctor-search-input"
                      placeholder={t('grid.search.date_placeholder')}
                      onChange={(date, dateString) => {
                        setFilters((prev) => ({
                          ...prev,
                          selectedDate: String(dateString),
                        }));
                        setCurrentPage(1);
                      }}
                    />
                  </div>
                </div>

                <div className="form-search-btn">
                  <button
                    className="btn btn-primary d-inline-flex align-items-center rounded-pill"
                    type="button"
                    onClick={() => setCurrentPage(1)}
                  >
                    <i className="isax isax-search-normal-15 me-2" />
                    {t('grid.search.search_button')}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div className="breadcrumb-bg">
          <ImageWithBasePath
            src="assets/img/bg/breadcrumb-icon.png"
            alt="img"
            className="breadcrumb-bg-03"
          />
          <ImageWithBasePath
            src="assets/img/bg/breadcrumb-icon.png"
            alt="img"
            className="breadcrumb-bg-04"
          />
        </div>
      </div>
      {/* /Breadcrumb */}

      <div className="content mt-5">
        <div className="container">
          <div className="row">
            <div className="col-xl-3">
              <div className="card filter-lists">
                <div className="card-header">
                  <div className="d-flex align-items-center filter-head justify-content-between">
                    <h4>{t('grid.filters.title')}</h4>
                    <Link
                      to="#"
                      className="text-secondary text-decoration-underline"
                      onClick={(e) => {
                        e.preventDefault();
                        setFilters({
                          selectedSpecialities: [],
                          // selectedAvailability: [],
                          selectedChannels: [],
                          selectedGenders: [],
                          selectedLanguages: [],
                          // selectedClinics: [],
                          selectedExperience: [],
                          priceRange: [minPriceVal, maxPriceVal],
                          selectedRatings: [],
                          searchText: "",
                          selectedDate: "",
                          locationText: "",
                        });
                        setCurrentPage(1);
                        setSortOrder("none");
                      }}
                    >
                      {t('grid.filters.clear_all')}
                    </Link>
                  </div>
                  <div className="filter-input">
                    <div className="position-relative input-icon">
                      <input
                        type="text"
                        className="form-control"
                        value={filters.searchText}
                        onChange={(e) => setSearchText(e.target.value)}
                      />
                      <span>
                        <i className="isax isax-search-normal-1" />
                      </span>
                    </div>
                  </div>
                </div>
                <div className="card-body p-0">
                  <div className="accordion-item border-bottom">
                    <div className="accordion-header" id="heading1">
                      <div
                        className="accordion-button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse1"
                        aria-controls="collapse1"
                        role="button"
                      >
                        <div className="d-flex align-items-center w-100">
                          <h5>{t('grid.filters.specialities')}</h5>
                          <div className="ms-auto">
                            <span>
                              <i className="fas fa-chevron-down" />
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div
                      id="collapse1"
                      className="accordion-collapse show"
                      aria-labelledby="heading1"
                    >
                      <div className="accordion-body pt-3">
                        {/* Render top 6 specialities then the rest in the expandable view */}
                        {(() => {
                          const first = specialities.slice(0, 3);
                          const more = specialities.slice(3);
                          return (
                            <>
                              {first.map((s, idx) => (
                                <div
                                  className="d-flex align-items-center justify-content-between mb-2"
                                  key={`spec-${s}`}
                                >
                                  <div className="form-check">
                                    <input
                                      className="form-check-input"
                                      type="checkbox"
                                      id={`speciality-${idx}`}
                                      checked={filters.selectedSpecialities.includes(
                                        s
                                      )}
                                      onChange={() =>
                                        toggleFilter("selectedSpecialities", s)
                                      }
                                    />
                                    <label
                                      className="form-check-label"
                                      htmlFor={`speciality-${idx}`}
                                    >
                                      {s}
                                    </label>
                                  </div>
                                  <span className="filter-badge"></span>
                                </div>
                              ))}

                              <div className="view-content">
                                <div
                                  className="viewall-one"
                                  style={{
                                    display: !showMenu ? "none" : "block",
                                  }}
                                >
                                  {more.map((s, idx) => (
                                    <div
                                      className="d-flex align-items-center justify-content-between mb-2"
                                      key={`spec-more-${s}`}
                                    >
                                      <div className="form-check">
                                        <input
                                          className="form-check-input"
                                          type="checkbox"
                                          id={`speciality-more-${idx}`}
                                          checked={filters.selectedSpecialities.includes(
                                            s
                                          )}
                                          onChange={() =>
                                            toggleFilter(
                                              "selectedSpecialities",
                                              s
                                            )
                                          }
                                        />
                                        <label
                                          className="form-check-label"
                                          htmlFor={`speciality-more-${idx}`}
                                        >
                                          {s}
                                        </label>
                                      </div>
                                      <span className="filter-badge"></span>
                                    </div>
                                  ))}
                                </div>
                                <div className="view-all">
                                  <Link
                                    to="#"
                                    onClick={(e) => {
                                      e.preventDefault();
                                      setShowMenu(!showMenu);
                                    }}
                                    className="viewall-button-one text-secondary text-decoration-underline"
                                  >
                                    {showMenu ? t('grid.filters.view_less') : t('grid.filters.view_more')}
                                  </Link>
                                </div>
                              </div>
                            </>
                          );
                        })()}
                      </div>
                    </div>
                  </div>
                  <div className="accordion-item border-bottom">
                    <div className="accordion-header" id="heading2">
                      <div
                        className="accordion-button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse2"
                        aria-controls="collapse2"
                        role="button"
                      >
                        <div className="d-flex align-items-center w-100">
                          <h5>{t('grid.filters.gender')}</h5>
                          <div className="ms-auto">
                            <span>
                              <i className="fas fa-chevron-down" />
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div
                      id="collapse2"
                      className="accordion-collapse show"
                      aria-labelledby="heading2"
                    >
                      <div className="accordion-body pt-3">
                        <div className="d-flex align-items-center justify-content-between mb-2">
                          <div className="form-check">
                            <input
                              className="form-check-input"
                              type="checkbox"
                              id="checkebox-sm11"
                              checked={filters.selectedGenders.includes("Male")}
                              onChange={() =>
                                toggleFilter("selectedGenders", "Male")
                              }
                            />
                            <label
                              className="form-check-label"
                              htmlFor="checkebox-sm11"
                            >
                              {t('grid.filters.male')}
                            </label>
                          </div>
                          <span className="filter-badge"></span>
                        </div>
                        <div className="d-flex align-items-center justify-content-between">
                          <div className="form-check">
                            <input
                              className="form-check-input"
                              type="checkbox"
                              id="checkebox-sm12"
                              checked={filters.selectedGenders.includes(
                                "Female"
                              )}
                              onChange={() =>
                                toggleFilter("selectedGenders", "Female")
                              }
                            />
                            <label
                              className="form-check-label"
                              htmlFor="checkebox-sm12"
                            >
                              {t('grid.filters.female')}
                            </label>
                          </div>
                          <span className="filter-badge"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                  {/* Availability filter removed as requested */}
                  <div className="accordion-item border-bottom">
                    <div className="accordion-header" id="heading4">
                      <div
                        className="accordion-button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse4"
                        aria-controls="collapse4"
                        role="button"
                      >
                        <div className="d-flex align-items-center w-100">
                          <h5>{t('grid.filters.pricing')}</h5>
                          <div className="ms-auto">
                            <span>
                              <i className="fas fa-chevron-down" />
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div
                      id="collapse4"
                      className="accordion-collapse show"
                      aria-labelledby="heading4"
                    >
                      <div className="accordion-body pt-3">
                        <div className="filter-range">
                          <Slider
                            key={sliderKey}
                            range
                            tooltip={{ formatter }}
                            min={minPriceVal}
                            max={maxPriceVal}
                            value={filters.priceRange}
                            onChange={(val) =>
                              setPriceRange(val as [number, number])
                            }
                            reverse={isRTL}
                          />
                        </div>
                        <p className="mb-0">
                          {t('grid.filters.range')} : {minPriceVal} - {maxPriceVal} EGP
                        </p>
                      </div>
                    </div>
                  </div>
                  <div className="accordion-item border-bottom">
                    <div className="accordion-header" id="heading5">
                      <div
                        className="accordion-button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse5"
                        aria-controls="collapse5"
                        role="button"
                      >
                        <div className="d-flex align-items-center w-100">
                          <h5>{t('grid.filters.experience')}</h5>
                          <div className="ms-auto">
                            <span>
                              <i className="fas fa-chevron-down" />
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div
                      id="collapse5"
                      className="accordion-collapse show"
                      aria-labelledby="heading5"
                    >
                      <div className="accordion-body pt-3">
                        {[2, 5].map((yr) => (
                          <div
                            className="d-flex align-items-center justify-content-between mb-2"
                            key={`exp-${yr}`}
                          >
                            <div className="form-check">
                              <input
                                className="form-check-input"
                                type="checkbox"
                                id={`exp-${yr}`}
                                checked={filters.selectedExperience.includes(
                                  yr
                                )}
                                onChange={() =>
                                  toggleFilter("selectedExperience", yr)
                                }
                              />
                              <label
                                className="form-check-label"
                                htmlFor={`exp-${yr}`}
                              >{t('grid.filters.years_plus', { count: yr })}</label>
                            </div>
                          </div>
                        ))}
                        <div className="view-content">
                          <div
                            className="viewall-3"
                            style={{ display: !showMenu3 ? "none" : "block" }}
                          >
                            {[7, 10].map((yr) => (
                              <div
                                className="d-flex align-items-center justify-content-between mb-2"
                                key={`exp-more-${yr}`}
                              >
                                <div className="form-check">
                                  <input
                                    className="form-check-input"
                                    type="checkbox"
                                    id={`exp-more-${yr}`}
                                    checked={filters.selectedExperience.includes(
                                      yr
                                    )}
                                    onChange={() =>
                                      toggleFilter("selectedExperience", yr)
                                    }
                                  />
                                  <label
                                    className="form-check-label"
                                    htmlFor={`exp-more-${yr}`}
                                  >{t('grid.filters.years_plus', { count: yr })}</label>
                                </div>
                              </div>
                            ))}
                          </div>
                          <div className="view-all">
                            <Link
                              to="#"
                              onClick={(e) => {
                                e.preventDefault();
                                setShowMenu3(!showMenu3);
                              }}
                              className="viewall-button-3 text-secondary text-decoration-underline"
                            >
                              {showMenu3 ? t('grid.filters.view_less') : t('grid.filters.view_more')}
                            </Link>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  {/* Clinics filter removed as requested */}
                  <div className="accordion-item border-bottom">
                    <div className="accordion-header" id="heading7">
                      <div
                        className="accordion-button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse7"
                        aria-controls="collapse7"
                        role="button"
                      >
                        <div className="d-flex align-items-center w-100">
                          <h5>{t('grid.filters.consultation_type')}</h5>
                          <div className="ms-auto">
                            <span>
                              <i className="fas fa-chevron-down" />
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div
                      id="collapse7"
                      className="accordion-collapse show"
                      aria-labelledby="heading7"
                    >
                      <div className="accordion-body pt-3">
                        {[
                          { id: "Home", label: t('grid.channels.home') },
                          { id: "video", label: t('grid.channels.video') },
                          { id: "chat", label: t('grid.channels.chat') },
                          { id: "clinic", label: t('grid.doctor_card.clinic_visit') },
                        ].map((ch) => (
                          <div
                            className="d-flex align-items-center justify-content-between mb-2"
                            key={ch.id}
                          >
                            <div className="form-check">
                              <input
                                className="form-check-input"
                                type="checkbox"
                                id={`channel-${ch.id}`}
                                checked={filters.selectedChannels.includes(
                                  ch.id
                                )}
                                onChange={() =>
                                  toggleFilter("selectedChannels", ch.id)
                                }
                              />
                              <label
                                className="form-check-label"
                                htmlFor={`channel-${ch.id}`}
                              >
                                {ch.label}
                              </label>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                  <div className="accordion-item border-bottom">
                    <div className="accordion-header" id="heading8">
                      <div
                        className="accordion-button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse8"
                        aria-controls="collapse8"
                        role="button"
                      >
                        <div className="d-flex align-items-center w-100">
                          <h5>{t('grid.filters.languages')}</h5>
                          <div className="ms-auto">
                            <span>
                              <i className="fas fa-chevron-down" />
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div
                      id="collapse8"
                      className="accordion-collapse show"
                      aria-labelledby="heading8"
                    >
                      <div className="accordion-body pt-3">
                        {["Arabic", "English"].map((lang, i) => (
                          <div
                            className="d-flex align-items-center justify-content-between mb-2"
                            key={`lang-${i}`}
                          >
                            <div className="form-check">
                              <input
                                className="form-check-input"
                                type="checkbox"
                                id={`lang-${i}`}
                                checked={filters.selectedLanguages.includes(
                                  lang
                                )}
                                onChange={() =>
                                  toggleFilter("selectedLanguages", lang)
                                }
                              />
                              <label
                                className="form-check-label"
                                htmlFor={`lang-${i}`}
                              >
                                {lang}
                              </label>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                  <div className="accordion-item">
                    <div className="accordion-header" id="heading9">
                      <div
                        className="accordion-button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse9"
                        aria-controls="collapse9"
                        role="button"
                      >
                        <div className="d-flex align-items-center w-100">
                          <h5>{t('grid.filters.rating')}</h5>
                          <div className="ms-auto">
                            <span>
                              <i className="fas fa-chevron-down" />
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div
                      id="collapse9"
                      className="accordion-collapse show"
                      aria-labelledby="heading9"
                    >
                      <div className="accordion-body pt-3">
                        {ratingOptions.map((r) => (
                          <div
                            className="d-flex align-items-center justify-content-between mb-2"
                            key={`rating-${r}`}
                          >
                            <div className="form-check">
                              <input
                                className="form-check-input"
                                type="checkbox"
                                id={`rating-${r}`}
                                checked={filters.selectedRatings.includes(r)}
                                onChange={() =>
                                  toggleFilter("selectedRatings", r)
                                }
                              />
                              <label
                                className="form-check-label"
                                htmlFor={`rating-${r}`}
                              >
                                <span>
                                  {Array.from({ length: r }).map((_, i) => (
                                    <i
                                      key={i}
                                      className="fa-solid fa-star text-orange me-1"
                                    />
                                  ))}
                                </span>
                                {` ${t('grid.filters.stars_up', { count: r })}`}
                              </label>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div className="col-xl-9">
              <div className="row align-items-center">
                <div className="col-md-6">
                  <div className="mb-4">
                    <h3>
                      {t('grid.sorting.showing_results', { 
                        count: currentDoctors.length, 
                        total: filteredAndSorted.length 
                      })}
                    </h3>
                  </div>
                </div>
                <div className="col-md-6">
                  <div className="d-flex align-items-center justify-content-end mb-4">
                    <div className="dropdown header-dropdown me-2">
                      <Link
                        className="dropdown-toggle sort-dropdown"
                        data-bs-toggle="dropdown"
                        to="#"
                        aria-expanded="false"
                      >
                        <span>{t('grid.sorting.sort_by')} </span>
                        {sortOrder === "low"
                          ? t('grid.sorting.price_low_high')
                          : sortOrder === "high"
                          ? t('grid.sorting.price_high_low')
                          : t('grid.sorting.recommended')}
                      </Link>
                      <div className="dropdown-menu dropdown-menu-end">
                        <Link
                          to="#"
                          className="dropdown-item"
                          onClick={() => {
                            setSortOrder("none");
                            setCurrentPage(1); // reset to first page
                          }}
                        >
                          {t('grid.sorting.recommended')}
                        </Link>

                        <Link
                          to="#"
                          className="dropdown-item"
                          onClick={() => {
                            setSortOrder("low");
                            setCurrentPage(1);
                          }}
                        >
                          {t('grid.sorting.price_low_high')}
                        </Link>

                        <Link
                          to="#"
                          className="dropdown-item"
                          onClick={() => {
                            setSortOrder("high");
                            setCurrentPage(1);
                          }}
                        >
                          {t('grid.sorting.price_high_low')}
                        </Link>
                      </div>
                    </div>

                    <Link
                      to={route.doctorGrid}
                      className="btn btn-sm head-icon active me-2"
                    >
                      <i className="isax isax-grid-7" />
                    </Link>
                  </div>
                </div>
              </div>
              <div className="row">
                {/* Map through doctors data to dynamically render doctor cards */}
                {currentDoctors.map((doctor) => (
                  <div key={doctor.id} className="col-xxl-4 col-md-6 mb-4">
                    <div className="card doctor-card-enhanced">
                      {/* Doctor image section with 1:1 ratio */}
                      <div className="card-img card-img-hover doctor-image-wrapper">
                        <Link
                          to={`/doctors/${doctor.doctorName
                            .replace(/\s+/g, "-")
                            .toLowerCase()}`}
                        >
                          <ImageWithBasePath
                            src={doctor.image}
                            alt={doctor.doctorName}
                            className="doctor-card-image"
                            width={500}
                            height={500}
                          />
                        </Link>
                        {/* Verified badge overlay in top-left */}
                        <div className="verified-badge-overlay">
                          <span className="badge bg-primary">
                            <i className="fa-solid fa-check-circle me-1"></i>
                            {t('grid.doctor_card.verified')}
                          </span>
                        </div>
                      </div>

                      <div className="card-body doctor-card-body p-0">
                        {/* Speciality bar with colored background */}
                        <div
                          className={`d-flex ${doctor.specialityColorClass} align-items-center justify-content-between p-3 pb-2`}
                        >
                          <Link
                            to="#"
                            className={`${doctor.specialityTextClass} fw-medium fs-14`}
                          >
                            {doctor.speciality}
                          </Link>
                        </div>

                        {/* Main doctor information section */}
                        <div className="doctor-info-content p-3">
                          {/* Doctor name */}
                          <h3 className="doctor-name mb-2">
                            <Link
                              to={`/doctors/${doctor.doctorName
                                .replace(/\s+/g, "-")
                                .toLowerCase()}`}
                            >
                              {doctor.doctorName}
                            </Link>
                          </h3>

                          {/* Professional title */}
                          <p className="professional-title text-muted fs-13 mb-2">
                            {(doctor as any).professionalTitle ||
                              doctor.speciality}
                          </p>

                          {/* Experience */}
                          <p className="experience-badge text-muted fs-13 mb-3">
                            <i className="isax isax-calendar-1 me-1"></i>
                            {doctor.experienceYears}+ {t('grid.doctor_card.yrs_exp')}
                          </p>

                          {/* Services offered chips */}
                          <div className="services-offered mb-3">
                            <div className="service-chips-container">
                              {doctor.channels &&
                                doctor.channels.map((channel: string) => {
                                  const channelMap: any = {
                                    video: { icon: "fa-video", label: t('grid.channels.video') },
                                    audio: { icon: "fa-phone", label: "Call" },
                                    chat: { icon: "fa-message", label: t('grid.channels.chat') },
                                    Home: {
                                      icon: "fa-home",
                                      label: t('grid.channels.home'),
                                    },
                                    clinic: {
                                      icon: "fa-hospital",
                                      label: t('grid.doctor_card.clinic_visit'),
                                    },
                                  };
                                  const service = channelMap[channel] || {
                                    icon: "fa-hospital",
                                    label: channel,
                                  };
                                  return (
                                    <span
                                      key={channel}
                                      className="service-chip"
                                      title={service.label}
                                    >
                                      <i
                                        className={`fa-solid ${service.icon}`}
                                      ></i>
                                      <span className="chip-label">
                                        {service.label}
                                      </span>
                                    </span>
                                  );
                                })}
                            </div>
                          </div>

                          {/* Price section */}
                          <div className="price-section mb-3 pb-3 border-bottom border-light-2">
                            <p className="text-muted fs-13 mb-1">
                              {t('grid.doctor_card.starting_from')}
                            </p>
                            <div className="price-display">
                              <h4 className="text-orange mb-0">
                                {doctor.consultationFee}
                              </h4>
                              {(doctor as any).maxConsultationFee && (
                                <p className="text-muted fs-12 mb-0">
                                  {t('grid.doctor_card.to')} {(doctor as any).maxConsultationFee}
                                </p>
                              )}
                            </div>
                          </div>

                          {/* Location and availability */}
                          <div className="location-section d-flex align-items-center mb-3">
                            <i className="isax isax-location me-2 text-muted"></i>
                            <p className="text-muted fs-13 mb-0">
                              {doctor.location}
                            </p>
                          </div>

                          {/* Book Now button */}
                          <Link
                            to={`${route.booking}?doctorId=${doctor.id}`}
                            state={{ doctorId: doctor.id }}
                            className="btn btn-sm btn-primary w-100 rounded-pill"
                          >
                            <i className="isax isax-calendar-1 me-2"></i>
                            {t('grid.doctor_card.book_now')}
                          </Link>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}

                <div className="col-md-12">
                  <div className="pagination dashboard-pagination mt-4 mb-4">
                    <ul>
                      {/* Prev */}
                      <li>
                        <button
                          className="page-link prev"
                          disabled={currentPage === 1}
                          onClick={() => setCurrentPage(currentPage - 1)}
                        >
                          {t('grid.pagination.previous')}
                        </button>
                      </li>

                      {/* Page numbers */}
                      {Array.from({ length: totalPages }, (_, i) => i + 1).map(
                        (page) => (
                          <li key={page}>
                            <button
                              className={`page-link ${
                                currentPage === page ? "active" : ""
                              }`}
                              onClick={() => setCurrentPage(page)}
                            >
                              {page}
                            </button>
                          </li>
                        )
                      )}

                      {/* Next */}
                      <li>
                        <button
                          className="page-link next"
                          disabled={currentPage === totalPages}
                          onClick={() => setCurrentPage(currentPage + 1)}
                        >
                          {t('grid.pagination.next')}
                        </button>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {/* Include homepage1 footer */}
      <Footer />
    </>
  );
};

export default DoctorGrid;
